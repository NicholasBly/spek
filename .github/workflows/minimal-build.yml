name: Minimal Windows Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: List directory contents
      shell: pwsh
      run: |
        Get-ChildItem -Force
        if (Test-Path CMakeLists.txt) {
          Write-Output "CMakeLists.txt found in root"
        } else {
          Write-Output "CMakeLists.txt not found in root"
        }

    - name: Setup MinGW
      shell: pwsh
      run: |
        choco install mingw
        $env:PATH += ";C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin"
        [Environment]::SetEnvironmentVariable("PATH", $env:PATH, "Machine")
        Write-Output "Updated PATH: $env:PATH"

    - name: Verify GCC installation
      run: gcc --version

    - name: Compile (if no CMake)
      shell: pwsh
      run: |
        if (-not (Test-Path CMakeLists.txt)) {
          if (Test-Path src) {
            g++ -o spek.exe src/*.cpp
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Compilation failed"
              exit 1
            }
          } else {
            Write-Output "No src directory found. Please provide more information about your project structure."
            Get-ChildItem -Recurse
          }
        } else {
          Write-Output "CMakeLists.txt found, skipping direct compilation"
          Get-Content CMakeLists.txt
        }

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: spek
        path: spek.exe
